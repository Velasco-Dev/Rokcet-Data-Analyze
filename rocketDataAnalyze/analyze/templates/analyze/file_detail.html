{% extends 'analyze/base.html' %}

{% block title %}An√°lisis - {{ file.name }}{% endblock %}

{% block content %}
<div class="container-header">
    <div class="container">
        <h1>üìä An√°lisis: {{ file.name }}</h1>
        <p class="text-white">{{ file.filename }}</p>
    </div>
</div>

<div class="container-fluid">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb bg-white p-3 rounded shadow-sm">
            <li class="breadcrumb-item"><a href="{% url 'analyze:dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item active">{{ file.name }}</li>
        </ol>
    </nav>

    <!-- Tabs para seleccionar tipo de an√°lisis -->
    <ul class="nav nav-tabs mb-4" id="analysisTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if analysis_type == 'basic' %}active{% endif %}" 
                    onclick="window.location.href='?analysis=basic'" type="button">
                üìà An√°lisis B√°sico
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if analysis_type == 'complete' %}active{% endif %}" 
                    onclick="window.location.href='?analysis=complete'" type="button">
                üöÄ An√°lisis Completo (Todos los Requerimientos)
            </button>
        </li>
    </ul>

    <!-- Selector de fecha para datos meteorol√≥gicos (solo visible en an√°lisis completo) -->
    {% if analysis_type == 'complete' %}
    <div class="card mb-4 border-info">
        <div class="card-body bg-light">
            <form method="get" class="row g-3 align-items-end" id="weatherDateForm">
                <input type="hidden" name="analysis" value="complete">
                <div class="col-md-4">
                    <label for="weather_date" class="form-label">üìÖ Fecha para Datos Meteorol√≥gicos:</label>
                    <input type="date" class="form-control" id="weather_date" name="weather_date" 
                           value="{{ request.GET.weather_date }}"
                           max="{{ today|date:'Y-m-d' }}">
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-info">üîÑ Actualizar Datos Meteorol√≥gicos</button>
                </div>
                <div class="col-md-4">
                    <small class="text-muted">üí° Deja vac√≠o para usar la fecha del CSV</small>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    {% if analysis_type == 'basic' %}
    <!-- AN√ÅLISIS B√ÅSICO -->
    <!-- Estad√≠sticas -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">‚ÑπÔ∏è Informaci√≥n General</h5>
                </div>
                <div class="card-body">
                    <p><strong>Total de registros:</strong> {{ stats.total_records }}</p>
                    <p><strong>Duraci√≥n:</strong> {{ stats.duration_minutes|floatformat:2 }} min</p>
                    <p><strong>Inicio:</strong> {{ stats.time_range.start }}</p>
                    <p><strong>Fin:</strong> {{ stats.time_range.end }}</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">üìà Estad√≠sticas de Variables</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6 class="text-danger">üå°Ô∏è Temperatura </h6>
                            <small>
                                <strong>M√°x:</strong> {{ stats.temperature_stats.max|floatformat:2 }} ¬∞C<br>
                                <strong>M√≠n:</strong> {{ stats.temperature_stats.min|floatformat:2 }} ¬∞C<br>
                                <strong>Media:</strong> {{ stats.temperature_stats.mean|floatformat:2 }} ¬∞C
                            </small>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-warning">üí® Presi√≥n</h6>
                            <small>
                                <strong>M√°x:</strong> {{ stats.pressure_stats.max|floatformat:2 }} kPa<br>
                                <strong>M√≠n:</strong> {{ stats.pressure_stats.min|floatformat:2 }} kPa<br>
                                <strong>Media:</strong> {{ stats.pressure_stats.mean|floatformat:2 }} kPa
                            </small>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-success">üìç Altura</h6>
                            <small>
                                <strong>M√°x:</strong> {{ stats.altitude_stats.max|floatformat:2 }} m<br>
                                <strong>M√≠n:</strong> {{ stats.altitude_stats.min|floatformat:2 }} m<br>
                                <strong>Media:</strong> {{ stats.altitude_stats.mean|floatformat:2 }} m
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gr√°fica combinada -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="card-title mb-0">üîó Vista Combinada</h5>
        </div>
        <div class="card-body">
            {{ combined_plot|safe }}
        </div>
    </div>

    <!-- Gr√°ficas individuales interactivas -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="card-title mb-0">üìä Gr√°ficas Individuales Interactivas</h5>
        </div>
        <div class="card-body">
            {{ interactive_plots.temperature|safe }}
            {{ interactive_plots.pressure|safe }}
            {{ interactive_plots.altitude|safe }}
        </div>
    </div>

    <!-- Gr√°fica matplotlib (est√°tica) -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="card-title mb-0">üé® Vista R√°pida (Matplotlib)</h5>
        </div>
        <div class="card-body text-center">
            <img src="data:image/png;base64,{{ matplotlib_plot }}" 
                 alt="Gr√°ficas de an√°lisis" class="img-fluid rounded">
        </div>
    </div>

    {% elif analysis_type == 'complete' %}
    <!-- AN√ÅLISIS COMPLETO DE TODOS LOS REQUERIMIENTOS -->
    
    <!-- REQUERIMIENTO 1: AN√ÅLISIS COMPARATIVO Y VALIDACI√ìN MULTI-SENSOR -->
    <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white">
            <h3 class="card-title mb-0">üìã REQUERIMIENTO 1: An√°lisis Comparativo y Validaci√≥n Multi-Sensor</h3>
        </div>
        <div class="card-body">
            
            <!-- 1.1 Validaci√≥n Altura Te√≥rica vs Real -->
            <div class="mb-4">
                <h4 class="text-primary">1.1 üìè Validaci√≥n: Altura Te√≥rica vs Real (F√≥rmula de Littlewood)</h4>
                
                <!-- Explicaci√≥n de la Metodolog√≠a -->
                <div class="alert alert-secondary">
                    <h5>üìñ Metodolog√≠a y F√≥rmula Utilizada:</h5>
                    <p><strong>F√≥rmula de Littlewood (Barom√©trica Internacional):</strong></p>
                    <code>h = (T‚ÇÄ/L) √ó [1 - (P/P‚ÇÄ)^(R√óL/g√óM)] + h‚ÇÄ</code>
                    
                    <hr>
                    <p><strong>‚öôÔ∏è Configuraci√≥n Utilizada (editable en settings.py):</strong></p>
                    <ul>
                        <li><strong>Altura Base (ROCKET_BASE_ALTITUDE):</strong> {{ advanced_analysis.validation.error_stats.altura_base_configurada|floatformat:0 }} m</li>
                        <li><strong>Umbral de Detecci√≥n de Vuelo:</strong> {{ advanced_analysis.validation.error_stats.porcentaje_datos_reposo|floatformat:0 }}% de datos iniciales</li>
                    </ul>
                    
                    <hr>
                    <p><strong>üìä Constantes de la F√≥rmula (configurables en LITTLEWOOD_CONFIG):</strong></p>
                    <ul>
                        <li><strong>T‚ÇÄ:</strong> {{ advanced_analysis.validation.error_stats.config_usado.T0 }}</li>
                        <li><strong>L:</strong> {{ advanced_analysis.validation.error_stats.config_usado.L }}</li>
                        <li><strong>R:</strong> {{ advanced_analysis.validation.error_stats.config_usado.R }}</li>
                        <li><strong>g:</strong> {{ advanced_analysis.validation.error_stats.config_usado.g }}</li>
                        <li><strong>M:</strong> {{ advanced_analysis.validation.error_stats.config_usado.M }}</li>
                    </ul>
                    
                    <hr>
                    <p><strong>üìç Datos Utilizados para el C√°lculo:</strong></p>
                    <ul>
                        <li><strong>P‚ÇÄ (Presi√≥n de referencia):</strong> {{ advanced_analysis.validation.error_stats.presion_lanzamiento|floatformat:2 }} kPa 
                            <em>(promedio de {{ advanced_analysis.validation.error_stats.n_datos_reposo }} primeros registros = cohete en reposo)</em></li>
                        <li><strong>h‚ÇÄ (Altura de lanzamiento):</strong> {{ advanced_analysis.validation.error_stats.altura_lanzamiento|floatformat:1 }} m 
                            <em>(altura absoluta del punto de lanzamiento)</em></li>
                        {% if advanced_analysis.validation.error_stats.temperatura_lanzamiento %}
                        <li><strong>T (Temperatura de lanzamiento):</strong> {{ advanced_analysis.validation.error_stats.temperatura_lanzamiento|floatformat:1 }}¬∞C</li>
                        {% endif %}
                    </ul>
                    
                    <hr>
                    <p><strong>üîß C√≥mo Ajustar la Configuraci√≥n:</strong></p>
                    <ol>
                        <li>Abre <code>rocketDataAnalyze/settings.py</code></li>
                        <li>Busca la secci√≥n <strong>"CONFIGURACI√ìN DEL COHETE Y F√ìRMULAS"</strong></li>
                        <li>Modifica:
                            <ul>
                                <li><code>ROCKET_BASE_ALTITUDE = 160</code> ‚Üí Cambia seg√∫n tu altura de lanzamiento</li>
                                <li><code>LITTLEWOOD_CONFIG</code> ‚Üí Ajusta constantes de la f√≥rmula si necesitas</li>
                                <li><code>FLIGHT_DETECTION_THRESHOLD = 0.10</code> ‚Üí % de datos en reposo</li>
                                <li><code>MIN_FLIGHT_ALTITUDE = 1.0</code> ‚Üí Umbral m√≠nimo para detectar vuelo</li>
                            </ul>
                        </li>
                        <li>Reinicia el servidor Django</li>
                    </ol>
                    
                    <hr>
                    <p><strong>üìã Metodolog√≠a de C√°lculo:</strong></p>
                    <ol>
                        <li>Se identific√≥ el <strong>punto de lanzamiento</strong> como el promedio de los primeros {{ advanced_analysis.validation.error_stats.n_datos_reposo }} registros (cohete en reposo)</li>
                        <li><strong>Altura Real:</strong> Se usa directamente la del CSV (altura absoluta medida por el sensor BMP280)</li>
                        <li><strong>Altura Te√≥rica:</strong> Se calcula con Littlewood usando P‚ÇÄ y se suma h‚ÇÄ para obtener altura absoluta</li>
                        <li>Se comparan ambas alturas en <strong>la misma escala absoluta</strong> durante el vuelo ({{ advanced_analysis.validation.error_stats.n_datos_vuelo }} registros)</li>
                    </ol>
                    
                    <div class="alert alert-info mt-2">
                        <strong>‚ÑπÔ∏è Nota:</strong> Ambas alturas (Real y Te√≥rica) est√°n en valores absolutos (metros sobre nivel del mar o referencia), 
                        por lo que son directamente comparables. La altura del CSV (~158m) debe ser similar a la calculada con Littlewood.
                    </div>
                </div>
                
                <!-- Estad√≠sticas del Error -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-header bg-success text-white">
                                <h5>üöÄ Datos del Vuelo</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>Altura M√°xima Real:</strong> {{ advanced_analysis.validation.error_stats.altura_maxima_real|floatformat:2 }} m</p>
                                <p><strong>Altura M√°xima Te√≥rica (Littlewood):</strong> {{ advanced_analysis.validation.error_stats.altura_maxima_teorica|floatformat:2 }} m</p>
                                <p><strong>Registros en Vuelo:</strong> {{ advanced_analysis.validation.error_stats.n_datos_vuelo }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-header bg-warning text-dark">
                                <h5>üìä An√°lisis de Errores</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>Error Promedio:</strong> {{ advanced_analysis.validation.error_stats.error_promedio|floatformat:2 }} m 
                                   ({{ advanced_analysis.validation.error_stats.error_porcentual_promedio|floatformat:1 }}%)</p>
                                <p><strong>RMSE:</strong> {{ advanced_analysis.validation.error_stats.rmse|floatformat:2 }} m</p>
                                <p><strong>MAE:</strong> {{ advanced_analysis.validation.error_stats.mae|floatformat:2 }} m</p>
                                <p><strong>Rango de Error:</strong> [{{ advanced_analysis.validation.error_stats.error_min|floatformat:2 }}, 
                                   {{ advanced_analysis.validation.error_stats.error_max|floatformat:2 }}] m</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Gr√°fica -->
                {{ advanced_analysis.validation.plot|safe }}
                
                <!-- Interpretaci√≥n -->
                <div class="alert alert-success mt-3">
                    <h5>üí° Interpretaci√≥n:</h5>
                    <p>{{ advanced_analysis.validation.explicacion.interpretacion }}</p>
                    <p><strong>Punto de Referencia:</strong> {{ advanced_analysis.validation.explicacion.referencia_altura }} con presi√≥n de {{ advanced_analysis.validation.explicacion.referencia_presion }}</p>
                </div>
            </div>

            <!-- 1.2 Dashboard Ambiental -->
            <div class="mb-4">
                <h4 class="text-primary">1.2 üåê Dashboard Ambiental (Comparaci√≥n con Datos Externos)</h4>
                
                {% if advanced_analysis.weather_comparison.error %}
                    <div class="alert alert-warning">
                        <h5>‚ö†Ô∏è {{ advanced_analysis.weather_comparison.message }}</h5>
                        {% if advanced_analysis.weather_comparison.instructions %}
                            <p><strong>Instrucciones para activar:</strong></p>
                            <ol>
                                {% for instruction in advanced_analysis.weather_comparison.instructions %}
                                <li>{{ instruction }}</li>
                                {% endfor %}
                            </ol>
                        {% endif %}
                    </div>
                {% else %}
                    <!-- Informaci√≥n de la fecha consultada -->
                    <div class="alert alert-info">
                        <strong>üìÖ Fecha consultada:</strong> {{ advanced_analysis.weather_comparison.query_date }}
                        {% if advanced_analysis.weather_comparison.warning %}
                            <br><small class="text-warning">‚ö†Ô∏è {{ advanced_analysis.weather_comparison.warning }}</small>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-header bg-info text-white">
                                    <h5>üì° Datos del Sensor (Promedio)</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Temperatura:</strong> {{ advanced_analysis.weather_comparison.sensor_data.temperatura_sensor|floatformat:2 }} ¬∞C</p>
                                    <p><strong>Presi√≥n:</strong> {{ advanced_analysis.weather_comparison.sensor_data.presion_sensor|floatformat:2 }} kPa</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-header bg-warning text-dark">
                                    <h5>üå§Ô∏è Datos Meteorol√≥gicos ({{ advanced_analysis.weather_comparison.external_data.ubicacion }})</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Temperatura:</strong> {{ advanced_analysis.weather_comparison.external_data.temperatura_externa|floatformat:2 }} ¬∞C</p>
                                    <p><strong>Presi√≥n:</strong> {{ advanced_analysis.weather_comparison.external_data.presion_externa|floatformat:2 }} kPa</p>
                                    <p><strong>Humedad:</strong> {{ advanced_analysis.weather_comparison.external_data.humedad }}%</p>
                                    <p><strong>Condiciones:</strong> {{ advanced_analysis.weather_comparison.external_data.descripcion }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <h5>üìä An√°lisis de Diferencias:</h5>
                        <p><strong>Diferencia de Temperatura:</strong> {{ advanced_analysis.weather_comparison.comparisons.diff_temperatura|floatformat:2 }} ¬∞C 
                           ({{ advanced_analysis.weather_comparison.comparisons.diff_temperatura_pct|floatformat:1 }}%)</p>
                        <p><strong>Diferencia de Presi√≥n:</strong> {{ advanced_analysis.weather_comparison.comparisons.diff_presion|floatformat:2 }} kPa 
                           ({{ advanced_analysis.weather_comparison.comparisons.diff_presion_pct|floatformat:1 }}%)</p>
                    </div>
                    
                    <div class="alert alert-success">
                        <h5>üí° Interpretaci√≥n:</h5>
                        <ul>
                            {% for interp in advanced_analysis.weather_comparison.interpretation %}
                            <li>{{ interp }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    
                    {{ advanced_analysis.weather_comparison.plot_temperature|safe }}
                    {{ advanced_analysis.weather_comparison.plot_pressure|safe }}
                {% endif %}
            </div>

            <!-- 1.3 Curva Altitud vs Presi√≥n -->
            <div class="mb-4">
                <h4 class="text-primary">1.3 üìä Curva Altitud vs Presi√≥n vs Ecuaci√≥n Barom√©trica</h4>
                <div class="alert alert-secondary">
                    Esta gr√°fica compara los datos reales del sensor con la ecuaci√≥n barom√©trica te√≥rica para verificar la consistencia del sensor.
                </div>
                {{ advanced_analysis.altitude_pressure|safe }}
            </div>

        </div>
    </div>

    <!-- REQUERIMIENTO 2: DIAGN√ìSTICO DE EVENTOS Y ATM√ìSFERA -->
    <div class="card mb-4 border-success">
        <div class="card-header bg-success text-white">
            <h3 class="card-title mb-0">üìã REQUERIMIENTO 2: Diagn√≥stico de Eventos y Atm√≥sfera</h3>
        </div>
        <div class="card-body">
            
            <!-- 2.1 Fases del Vuelo -->
            <div class="mb-4">
                <h4 class="text-success">2.1 üöÄ Fases del Vuelo (Ascenso, Apogeo, Descenso)</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="alert alert-success">
                            <strong>üéØ Altura M√°xima (Apogeo):</strong> {{ advanced_analysis.flight_phases.stats.apogeo_altura|floatformat:2 }} m<br>
                            <strong>‚è±Ô∏è Tiempo al Apogeo:</strong> {{ advanced_analysis.flight_phases.stats.apogeo_tiempo }}<br>
                            <strong>‚è´ Duraci√≥n Ascenso:</strong> {{ advanced_analysis.flight_phases.stats.duracion_ascenso|floatformat:2 }} s
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-warning">
                            <strong>‚è¨ Duraci√≥n Descenso:</strong> {{ advanced_analysis.flight_phases.stats.duracion_descenso|floatformat:2 }} s<br>
                            <strong>‚ö° Velocidad M√°x Ascenso:</strong> {{ advanced_analysis.flight_phases.stats.velocidad_max_ascenso|floatformat:2 }} m/s<br>
                            <strong>ü™Ç Velocidad M√°x Descenso:</strong> {{ advanced_analysis.flight_phases.stats.velocidad_max_descenso|floatformat:2 }} m/s
                        </div>
                    </div>
                </div>
                {{ advanced_analysis.flight_phases.plot|safe }}
            </div>

            <!-- 2.2 An√°lisis Paraca√≠das -->
            <div class="mb-4">
                <h4 class="text-success">2.2 ü™Ç An√°lisis de Despliegue del Paraca√≠das</h4>
                <div class="alert {% if advanced_analysis.parachute.parachute_detected %}alert-success{% else %}alert-warning{% endif %}">
                    <strong>Estado:</strong> 
                    {% if advanced_analysis.parachute.parachute_detected %}
                        ‚úÖ Paraca√≠das detectado<br>
                        <strong>Tiempo de despliegue:</strong> {{ advanced_analysis.parachute.parachute_time }}<br>
                        <strong>Altura de despliegue:</strong> {{ advanced_analysis.parachute.parachute_height|floatformat:2 }} m
                    {% else %}
                        ‚ö†Ô∏è No se detect√≥ despliegue claro del paraca√≠das en los datos
                    {% endif %}
                </div>
                {{ advanced_analysis.parachute.plot|safe }}
            </div>

            <!-- 2.3 Densidad del Aire -->
            <div class="mb-4">
                <h4 class="text-success">2.3 üí® Densidad del Aire Durante el Vuelo</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <strong>Densidad Promedio:</strong> {{ advanced_analysis.air_density.stats.densidad_promedio|floatformat:4 }} kg/m¬≥<br>
                            <strong>Densidad M√°xima:</strong> {{ advanced_analysis.air_density.stats.densidad_max|floatformat:4 }} kg/m¬≥<br>
                            <strong>Densidad M√≠nima:</strong> {{ advanced_analysis.air_density.stats.densidad_min|floatformat:4 }} kg/m¬≥
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-secondary">
                            <strong>üìä Impacto en el Rendimiento:</strong><br>
                            <strong>Densidad en Ascenso:</strong> {{ advanced_analysis.air_density.impact_analysis.densidad_promedio_ascenso|floatformat:4 }} kg/m¬≥<br>
                            <strong>Densidad en Descenso:</strong> {{ advanced_analysis.air_density.impact_analysis.densidad_promedio_descenso|floatformat:4 }} kg/m¬≥<br>
                            <strong>Diferencia:</strong> {{ advanced_analysis.air_density.impact_analysis.diferencia_porcentual|floatformat:2 }}%<br>
                            <em>{{ advanced_analysis.air_density.impact_analysis.interpretacion }}</em>
                        </div>
                    </div>
                </div>
                {{ advanced_analysis.air_density.plot|safe }}
            </div>

            <!-- 2.4 Anomal√≠as -->
            <div class="mb-4">
                <h4 class="text-success">2.4 ‚ö†Ô∏è Detecci√≥n de Anomal√≠as</h4>
                <div class="alert alert-{% if advanced_analysis.anomalies.total_anomalies > 0 %}warning{% else %}success{% endif %}">
                    <strong>Total de Anomal√≠as Detectadas:</strong> {{ advanced_analysis.anomalies.total_anomalies }}
                </div>
                {% if advanced_analysis.anomalies.anomalies %}
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Timestamp</th>
                            <th>Valor</th>
                            <th>Altura</th>
                            <th>Causa Probable</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for anomaly in advanced_analysis.anomalies.anomalies %}
                        <tr>
                            <td><span class="badge bg-danger">{{ anomaly.tipo }}</span></td>
                            <td>{{ anomaly.timestamp }}</td>
                            <td>{{ anomaly.valor|floatformat:2 }}</td>
                            <td>{{ anomaly.altura|floatformat:2 }} m</td>
                            <td>{{ anomaly.causa_probable }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% endif %}
                {{ advanced_analysis.anomalies.plot|safe }}
            </div>

        </div>
    </div>

    <!-- REQUERIMIENTO 3: OPTIMIZACI√ìN BASADA EN EVIDENCIA -->
    <div class="card mb-4 border-warning">
        <div class="card-header bg-warning text-dark">
            <h3 class="card-title mb-0">üìã REQUERIMIENTO 3: Optimizaci√≥n Basada en Evidencia</h3>
        </div>
        <div class="card-body">
            
            <!-- 3.1 F√≥rmula del √âxito -->
            <div class="mb-4">
                <h4 class="text-warning">3.1 üèÜ F√≥rmula del √âxito: Condiciones √ìptimas</h4>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-header bg-success text-white">
                                <h5>üöÄ Condiciones de Lanzamiento</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>Presi√≥n Inicial:</strong> {{ advanced_analysis.success_formula.launch_conditions.presion_inicial|floatformat:2 }} kPa</p>
                                <p><strong>Temperatura Inicial:</strong> {{ advanced_analysis.success_formula.launch_conditions.temperatura_inicial|floatformat:2 }} ¬∞C</p>
                                <p><strong>Altura Inicial:</strong> {{ advanced_analysis.success_formula.launch_conditions.altura_inicial|floatformat:2 }} m</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-header bg-warning text-dark">
                                <h5>üéØ Resultados en el Apogeo</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>Altura M√°xima:</strong> {{ advanced_analysis.success_formula.apogee_conditions.altura_maxima|floatformat:2 }} m</p>
                                <p><strong>Tiempo hasta Apogeo:</strong> {{ advanced_analysis.success_formula.apogee_conditions.tiempo_al_apogeo|floatformat:2 }} s</p>
                                <p><strong>Temperatura en Apogeo:</strong> {{ advanced_analysis.success_formula.apogee_conditions.temperatura_apogeo|floatformat:2 }} ¬∞C</p>
                                <p><strong>Presi√≥n en Apogeo:</strong> {{ advanced_analysis.success_formula.apogee_conditions.presion_apogeo|floatformat:2 }} kPa</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-success mt-3">
                    <h5>‚ú® Recomendaciones para Optimizaci√≥n:</h5>
                    <ul>
                        {% for rec in advanced_analysis.success_formula.recommendations %}
                        <li>{{ rec }}</li>
                        {% endfor %}
                    </ul>
                </div>

                {{ advanced_analysis.success_formula.plot|safe }}
            </div>

        </div>
    </div>

    {% endif %}

    <!-- Bot√≥n volver -->
    <div class="mb-4">
        <a href="{% url 'analyze:dashboard' %}" class="btn btn-primary btn-lg">
            ‚Üê Volver al Dashboard
        </a>
    </div>
</div>

{% endblock %}