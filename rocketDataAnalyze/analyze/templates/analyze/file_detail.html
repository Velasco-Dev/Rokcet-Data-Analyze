{% extends 'analyze/base.html' %}

{% block title %}AnÃ¡lisis - {{ file.name }}{% endblock %}

{% block content %}
<div class="container-header">
    <div class="container">
        <h1>ğŸ“Š AnÃ¡lisis: {{ file.name }}</h1>
        <p class="text-white">{{ file.filename }}</p>
    </div>
</div>

<div class="container-fluid">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb bg-white p-3 rounded shadow-sm">
            <li class="breadcrumb-item"><a href="{% url 'analyze:dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item active">{{ file.name }}</li>
        </ol>
    </nav>

    <!-- Tabs para seleccionar tipo de anÃ¡lisis -->
    <ul class="nav nav-tabs mb-4" id="analysisTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if analysis_type == 'basic' %}active{% endif %}" 
                    onclick="window.location.href='?analysis=basic'" type="button">
                ğŸ“ˆ AnÃ¡lisis BÃ¡sico
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if analysis_type == 'complete' %}active{% endif %}" 
                    onclick="window.location.href='?analysis=complete'" type="button">
                ğŸš€ AnÃ¡lisis Completo (Todos los Requerimientos)
            </button>
        </li>
    </ul>

    <!-- Selector de fecha para datos meteorolÃ³gicos (solo visible en anÃ¡lisis completo) -->
    {% if analysis_type == 'complete' %}
    <div class="card mb-4 border-info">
        <div class="card-body bg-light">
            <form method="get" class="row g-3 align-items-end" id="weatherDateForm">
                <input type="hidden" name="analysis" value="complete">
                <div class="col-md-4">
                    <label for="weather_date" class="form-label">ğŸ“… Fecha para Datos MeteorolÃ³gicos:</label>
                    <input type="date" class="form-control" id="weather_date" name="weather_date" 
                           value="{{ request.GET.weather_date }}"
                           max="{{ today|date:'Y-m-d' }}">
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-info">ğŸ”„ Actualizar Datos MeteorolÃ³gicos</button>
                </div>
                <div class="col-md-4">
                    <small class="text-muted">ğŸ’¡ Deja vacÃ­o para usar la fecha del CSV</small>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    {% if analysis_type == 'basic' %}
    <!-- ANÃLISIS BÃSICO -->
    <!-- EstadÃ­sticas -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">â„¹ï¸ InformaciÃ³n General</h5>
                </div>
                <div class="card-body">
                    <p><strong>Total de registros:</strong> {{ stats.total_records }}</p>
                    <p><strong>DuraciÃ³n:</strong> {{ stats.duration_minutes|floatformat:2 }} min</p>
                    <p><strong>Inicio:</strong> {{ stats.time_range.start }}</p>
                    <p><strong>Fin:</strong> {{ stats.time_range.end }}</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">ğŸ“ˆ EstadÃ­sticas de Variables</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6 class="text-danger">ğŸŒ¡ï¸ Temperatura </h6>
                            <small>
                                <strong>MÃ¡x:</strong> {{ stats.temperature_stats.max|floatformat:2 }} Â°C<br>
                                <strong>MÃ­n:</strong> {{ stats.temperature_stats.min|floatformat:2 }} Â°C<br>
                                <strong>Media:</strong> {{ stats.temperature_stats.mean|floatformat:2 }} Â°C
                            </small>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-warning">ğŸ’¨ PresiÃ³n</h6>
                            <small>
                                <strong>MÃ¡x:</strong> {{ stats.pressure_stats.max|floatformat:2 }} kPa<br>
                                <strong>MÃ­n:</strong> {{ stats.pressure_stats.min|floatformat:2 }} kPa<br>
                                <strong>Media:</strong> {{ stats.pressure_stats.mean|floatformat:2 }} kPa
                            </small>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-success">ğŸ“ Altura</h6>
                            <small>
                                <strong>MÃ¡x:</strong> {{ stats.altitude_stats.max|floatformat:2 }} m<br>
                                <strong>MÃ­n:</strong> {{ stats.altitude_stats.min|floatformat:2 }} m<br>
                                <strong>Media:</strong> {{ stats.altitude_stats.mean|floatformat:2 }} m
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GrÃ¡fica combinada -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="card-title mb-0">ğŸ”— Vista Combinada</h5>
        </div>
        <div class="card-body">
            {{ combined_plot|safe }}
        </div>
    </div>

    <!-- GrÃ¡ficas individuales interactivas -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="card-title mb-0">ğŸ“Š GrÃ¡ficas Individuales Interactivas</h5>
        </div>
        <div class="card-body">
            {{ interactive_plots.temperature|safe }}
            {{ interactive_plots.pressure|safe }}
            {{ interactive_plots.altitude|safe }}
        </div>
    </div>

    <!-- GrÃ¡fica matplotlib (estÃ¡tica) -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="card-title mb-0">ğŸ¨ Vista RÃ¡pida (Matplotlib)</h5>
        </div>
        <div class="card-body text-center">
            <img src="data:image/png;base64,{{ matplotlib_plot }}" 
                 alt="GrÃ¡ficas de anÃ¡lisis" class="img-fluid rounded">
        </div>
    </div>

    {% elif analysis_type == 'complete' %}
    <!-- ANÃLISIS COMPLETO DE TODOS LOS REQUERIMIENTOS -->
    
    <!-- REQUERIMIENTO 1: ANÃLISIS COMPARATIVO Y VALIDACIÃ“N MULTI-SENSOR -->
    <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white">
            <h3 class="card-title mb-0">ğŸ“‹ REQUERIMIENTO 1: AnÃ¡lisis Comparativo y ValidaciÃ³n Multi-Sensor</h3>
        </div>
        <div class="card-body">
            
            <!-- 1.1 ValidaciÃ³n Altura TeÃ³rica vs Real -->
            <div class="mb-4">
                <h4 class="text-primary">1.1 ğŸ“ ValidaciÃ³n: Altura TeÃ³rica vs Real (FÃ³rmula de Littlewood)</h4>
                <div class="alert alert-info">
                    <strong>Error Promedio:</strong> {{ advanced_analysis.validation.error_stats.error_promedio|floatformat:2 }} m<br>
                    <strong>Error Porcentual Promedio:</strong> {{ advanced_analysis.validation.error_stats.error_porcentual_promedio|floatformat:2 }}%<br>
                    <strong>RMSE:</strong> {{ advanced_analysis.validation.error_stats.rmse|floatformat:2 }} m<br>
                    <strong>Error MÃ¡ximo:</strong> {{ advanced_analysis.validation.error_stats.error_max|floatformat:2 }} m<br>
                    <strong>Error MÃ­nimo:</strong> {{ advanced_analysis.validation.error_stats.error_min|floatformat:2 }} m
                </div>
                {{ advanced_analysis.validation.plot|safe }}
            </div>

            <!-- 1.2 Dashboard Ambiental -->
            <div class="mb-4">
                <h4 class="text-primary">1.2 ğŸŒ Dashboard Ambiental (ComparaciÃ³n con Datos Externos)</h4>
                
                {% if advanced_analysis.weather_comparison.error %}
                    <div class="alert alert-warning">
                        <h5>âš ï¸ {{ advanced_analysis.weather_comparison.message }}</h5>
                        {% if advanced_analysis.weather_comparison.instructions %}
                            <p><strong>Instrucciones para activar:</strong></p>
                            <ol>
                                {% for instruction in advanced_analysis.weather_comparison.instructions %}
                                <li>{{ instruction }}</li>
                                {% endfor %}
                            </ol>
                        {% endif %}
                    </div>
                {% else %}
                    <!-- InformaciÃ³n de la fecha consultada -->
                    <div class="alert alert-info">
                        <strong>ğŸ“… Fecha consultada:</strong> {{ advanced_analysis.weather_comparison.query_date }}
                        {% if advanced_analysis.weather_comparison.warning %}
                            <br><small class="text-warning">âš ï¸ {{ advanced_analysis.weather_comparison.warning }}</small>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-header bg-info text-white">
                                    <h5>ğŸ“¡ Datos del Sensor (Promedio)</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Temperatura:</strong> {{ advanced_analysis.weather_comparison.sensor_data.temperatura_sensor|floatformat:2 }} Â°C</p>
                                    <p><strong>PresiÃ³n:</strong> {{ advanced_analysis.weather_comparison.sensor_data.presion_sensor|floatformat:2 }} kPa</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-header bg-warning text-dark">
                                    <h5>ğŸŒ¤ï¸ Datos MeteorolÃ³gicos ({{ advanced_analysis.weather_comparison.external_data.ubicacion }})</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Temperatura:</strong> {{ advanced_analysis.weather_comparison.external_data.temperatura_externa|floatformat:2 }} Â°C</p>
                                    <p><strong>PresiÃ³n:</strong> {{ advanced_analysis.weather_comparison.external_data.presion_externa|floatformat:2 }} kPa</p>
                                    <p><strong>Humedad:</strong> {{ advanced_analysis.weather_comparison.external_data.humedad }}%</p>
                                    <p><strong>Condiciones:</strong> {{ advanced_analysis.weather_comparison.external_data.descripcion }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <h5>ğŸ“Š AnÃ¡lisis de Diferencias:</h5>
                        <p><strong>Diferencia de Temperatura:</strong> {{ advanced_analysis.weather_comparison.comparisons.diff_temperatura|floatformat:2 }} Â°C 
                           ({{ advanced_analysis.weather_comparison.comparisons.diff_temperatura_pct|floatformat:1 }}%)</p>
                        <p><strong>Diferencia de PresiÃ³n:</strong> {{ advanced_analysis.weather_comparison.comparisons.diff_presion|floatformat:2 }} kPa 
                           ({{ advanced_analysis.weather_comparison.comparisons.diff_presion_pct|floatformat:1 }}%)</p>
                    </div>
                    
                    <div class="alert alert-success">
                        <h5>ğŸ’¡ InterpretaciÃ³n:</h5>
                        <ul>
                            {% for interp in advanced_analysis.weather_comparison.interpretation %}
                            <li>{{ interp }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    
                    {{ advanced_analysis.weather_comparison.plot_temperature|safe }}
                    {{ advanced_analysis.weather_comparison.plot_pressure|safe }}
                {% endif %}
            </div>

            <!-- 1.3 Curva Altitud vs PresiÃ³n -->
            <div class="mb-4">
                <h4 class="text-primary">1.3 ğŸ“Š Curva Altitud vs PresiÃ³n vs EcuaciÃ³n BaromÃ©trica</h4>
                <div class="alert alert-secondary">
                    Esta grÃ¡fica compara los datos reales del sensor con la ecuaciÃ³n baromÃ©trica teÃ³rica para verificar la consistencia del sensor.
                </div>
                {{ advanced_analysis.altitude_pressure|safe }}
            </div>

        </div>
    </div>

    <!-- REQUERIMIENTO 2: DIAGNÃ“STICO DE EVENTOS Y ATMÃ“SFERA -->
    <div class="card mb-4 border-success">
        <div class="card-header bg-success text-white">
            <h3 class="card-title mb-0">ğŸ“‹ REQUERIMIENTO 2: DiagnÃ³stico de Eventos y AtmÃ³sfera</h3>
        </div>
        <div class="card-body">
            
            <!-- 2.1 Fases del Vuelo -->
            <div class="mb-4">
                <h4 class="text-success">2.1 ğŸš€ Fases del Vuelo (Ascenso, Apogeo, Descenso)</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="alert alert-success">
                            <strong>ğŸ¯ Altura MÃ¡xima (Apogeo):</strong> {{ advanced_analysis.flight_phases.stats.apogeo_altura|floatformat:2 }} m<br>
                            <strong>â±ï¸ Tiempo al Apogeo:</strong> {{ advanced_analysis.flight_phases.stats.apogeo_tiempo }}<br>
                            <strong>â« DuraciÃ³n Ascenso:</strong> {{ advanced_analysis.flight_phases.stats.duracion_ascenso|floatformat:2 }} s
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-warning">
                            <strong>â¬ DuraciÃ³n Descenso:</strong> {{ advanced_analysis.flight_phases.stats.duracion_descenso|floatformat:2 }} s<br>
                            <strong>âš¡ Velocidad MÃ¡x Ascenso:</strong> {{ advanced_analysis.flight_phases.stats.velocidad_max_ascenso|floatformat:2 }} m/s<br>
                            <strong>ğŸª‚ Velocidad MÃ¡x Descenso:</strong> {{ advanced_analysis.flight_phases.stats.velocidad_max_descenso|floatformat:2 }} m/s
                        </div>
                    </div>
                </div>
                {{ advanced_analysis.flight_phases.plot|safe }}
            </div>

            <!-- 2.2 AnÃ¡lisis ParacaÃ­das -->
            <div class="mb-4">
                <h4 class="text-success">2.2 ğŸª‚ AnÃ¡lisis de Despliegue del ParacaÃ­das</h4>
                <div class="alert {% if advanced_analysis.parachute.parachute_detected %}alert-success{% else %}alert-warning{% endif %}">
                    <strong>Estado:</strong> 
                    {% if advanced_analysis.parachute.parachute_detected %}
                        âœ… ParacaÃ­das detectado<br>
                        <strong>Tiempo de despliegue:</strong> {{ advanced_analysis.parachute.parachute_time }}<br>
                        <strong>Altura de despliegue:</strong> {{ advanced_analysis.parachute.parachute_height|floatformat:2 }} m
                    {% else %}
                        âš ï¸ No se detectÃ³ despliegue claro del paracaÃ­das en los datos
                    {% endif %}
                </div>
                {{ advanced_analysis.parachute.plot|safe }}
            </div>

            <!-- 2.3 Densidad del Aire -->
            <div class="mb-4">
                <h4 class="text-success">2.3 ğŸ’¨ Densidad del Aire Durante el Vuelo</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <strong>Densidad Promedio:</strong> {{ advanced_analysis.air_density.stats.densidad_promedio|floatformat:4 }} kg/mÂ³<br>
                            <strong>Densidad MÃ¡xima:</strong> {{ advanced_analysis.air_density.stats.densidad_max|floatformat:4 }} kg/mÂ³<br>
                            <strong>Densidad MÃ­nima:</strong> {{ advanced_analysis.air_density.stats.densidad_min|floatformat:4 }} kg/mÂ³
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-secondary">
                            <strong>ğŸ“Š Impacto en el Rendimiento:</strong><br>
                            <strong>Densidad en Ascenso:</strong> {{ advanced_analysis.air_density.impact_analysis.densidad_promedio_ascenso|floatformat:4 }} kg/mÂ³<br>
                            <strong>Densidad en Descenso:</strong> {{ advanced_analysis.air_density.impact_analysis.densidad_promedio_descenso|floatformat:4 }} kg/mÂ³<br>
                            <strong>Diferencia:</strong> {{ advanced_analysis.air_density.impact_analysis.diferencia_porcentual|floatformat:2 }}%<br>
                            <em>{{ advanced_analysis.air_density.impact_analysis.interpretacion }}</em>
                        </div>
                    </div>
                </div>
                {{ advanced_analysis.air_density.plot|safe }}
            </div>

            <!-- 2.4 AnomalÃ­as -->
            <div class="mb-4">
                <h4 class="text-success">2.4 âš ï¸ DetecciÃ³n de AnomalÃ­as</h4>
                <div class="alert alert-{% if advanced_analysis.anomalies.total_anomalies > 0 %}warning{% else %}success{% endif %}">
                    <strong>Total de AnomalÃ­as Detectadas:</strong> {{ advanced_analysis.anomalies.total_anomalies }}
                </div>
                {% if advanced_analysis.anomalies.anomalies %}
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Timestamp</th>
                            <th>Valor</th>
                            <th>Altura</th>
                            <th>Causa Probable</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for anomaly in advanced_analysis.anomalies.anomalies %}
                        <tr>
                            <td><span class="badge bg-danger">{{ anomaly.tipo }}</span></td>
                            <td>{{ anomaly.timestamp }}</td>
                            <td>{{ anomaly.valor|floatformat:2 }}</td>
                            <td>{{ anomaly.altura|floatformat:2 }} m</td>
                            <td>{{ anomaly.causa_probable }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% endif %}
                {{ advanced_analysis.anomalies.plot|safe }}
            </div>

        </div>
    </div>

    <!-- REQUERIMIENTO 3: OPTIMIZACIÃ“N BASADA EN EVIDENCIA -->
    <div class="card mb-4 border-warning">
        <div class="card-header bg-warning text-dark">
            <h3 class="card-title mb-0">ğŸ“‹ REQUERIMIENTO 3: OptimizaciÃ³n Basada en Evidencia</h3>
        </div>
        <div class="card-body">
            
            <!-- 3.1 FÃ³rmula del Ã‰xito -->
            <div class="mb-4">
                <h4 class="text-warning">3.1 ğŸ† FÃ³rmula del Ã‰xito: Condiciones Ã“ptimas</h4>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-header bg-success text-white">
                                <h5>ğŸš€ Condiciones de Lanzamiento</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>PresiÃ³n Inicial:</strong> {{ advanced_analysis.success_formula.launch_conditions.presion_inicial|floatformat:2 }} kPa</p>
                                <p><strong>Temperatura Inicial:</strong> {{ advanced_analysis.success_formula.launch_conditions.temperatura_inicial|floatformat:2 }} Â°C</p>
                                <p><strong>Altura Inicial:</strong> {{ advanced_analysis.success_formula.launch_conditions.altura_inicial|floatformat:2 }} m</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-header bg-warning text-dark">
                                <h5>ğŸ¯ Resultados en el Apogeo</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>Altura MÃ¡xima:</strong> {{ advanced_analysis.success_formula.apogee_conditions.altura_maxima|floatformat:2 }} m</p>
                                <p><strong>Tiempo hasta Apogeo:</strong> {{ advanced_analysis.success_formula.apogee_conditions.tiempo_al_apogeo|floatformat:2 }} s</p>
                                <p><strong>Temperatura en Apogeo:</strong> {{ advanced_analysis.success_formula.apogee_conditions.temperatura_apogeo|floatformat:2 }} Â°C</p>
                                <p><strong>PresiÃ³n en Apogeo:</strong> {{ advanced_analysis.success_formula.apogee_conditions.presion_apogeo|floatformat:2 }} kPa</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-success mt-3">
                    <h5>âœ¨ Recomendaciones para OptimizaciÃ³n:</h5>
                    <ul>
                        {% for rec in advanced_analysis.success_formula.recommendations %}
                        <li>{{ rec }}</li>
                        {% endfor %}
                    </ul>
                </div>

                {{ advanced_analysis.success_formula.plot|safe }}
            </div>

        </div>
    </div>

    {% endif %}

    <!-- BotÃ³n volver -->
    <div class="mb-4">
        <a href="{% url 'analyze:dashboard' %}" class="btn btn-primary btn-lg">
            â† Volver al Dashboard
        </a>
    </div>
</div>

{% endblock %}